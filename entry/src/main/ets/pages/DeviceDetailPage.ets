import { DeviceDetailPageLogic, TrendResult, SERVER_HOST } from './DeviceDetailPageLogic';
import webview from '@ohos.web.webview';
import http from '@ohos.net.http';
import ConfigurationConstant from '@ohos.app.ability.ConfigurationConstant';
import { emitter } from '@kit.BasicServicesKit';

// å®šä½æŸ¥è¯¢æ¥å£è¿”å›ç»“æ„
interface LocationQueryResponse {
  success?: boolean;
  message?: string;
  error?: string;
}

// é¡¶å±‚è¶‹åŠ¿è¡Œç»„ä»¶ï¼ˆé¿å…ä½œç”¨åŸŸé—®é¢˜ï¼‰
@Component
struct TrendRow {
  @Prop trend: TrendResult;

  build() {
    Row({ space: 4 }) {
      if (this.trend.direction === 'up') {
        Text('â†‘')
          .fontSize(14)
          .fontColor('#dc2626')
      } else if (this.trend.direction === 'down') {
        Text('â†“')
          .fontSize(14)
          .fontColor('#16a34a')
      } else {
        Text('â€”')
          .fontSize(14)
          .fontColor('#64748b')
      }
      Text(this.trend.text)
        .fontSize(12)
        .fontColor(this.trend.direction === 'up' ? '#dc2626' :
          this.trend.direction === 'down' ? '#16a34a' : '#64748b')
    }

  }
}

// é¡¶å±‚æŒ‡æ ‡å¡ç‰‡ç»„ä»¶
@Component
struct MetricCard {
  @Prop title: string;
  @Prop valueText: string;
  @Prop trend: TrendResult;
  @Prop valueFontSize: number;

  build() {
    Row({ space: 5 }) {
      Column() {
        Column({ space: 10 }) {
          Text(this.title)
            .fontSize(14)
            .fontColor($r("app.color.home_title_text"))
          Text(this.valueText)
            .fontSize(this.valueFontSize)
            .fontWeight(FontWeight.Bolder)
            .fontColor($r("app.color.home_value_text"))
            .maxLines(1)
        }
        .alignItems(HorizontalAlign.Start)

        TrendRow({ trend: this.trend })
      }
      .height('100%')
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width("100%")
    .height(100)
    .padding({
      left: 10,
      top: 10,
      right: 10,
      bottom: 10
    })
    .borderColor($r("app.color.home_card_border"))
    .borderWidth(1)
    .backgroundColor($r("app.color.home_card_background"))
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#1F000000',
      offsetX: 0,
      offsetY: 2
    })
  }
}


// å‡çº§ä¸ºä¸»é¡µé¢ç»„ä»¶ä¸º @ComponentV2
@ComponentV2
export struct DeviceDetailPage {
  // 1. æ¥æ”¶è·¯ç”±æ ˆï¼Œç”¨äºå›é€€
  @Consumer('pageStack') pageStack: NavPathStack = new NavPathStack();
  // 2. æ¥æ”¶é¡µé¢å‚æ•°
  @Local deviceId: string = "";
  @Local deviceName: string = ""; // è®¾å¤‡åç§°
  // UI çŠ¶æ€ (å…¨éƒ¨å‡çº§ä¸º @Local)
  @Local wsConnected: boolean = false;
  @Local temp: number | undefined = undefined;
  @Local hum: number | undefined = undefined;
  @Local lux: number | undefined = undefined;
  @Local smoke: number | undefined = undefined;
  @Local pressure: number | undefined = undefined;
  @Local temp2: number | undefined = undefined;
  @Local rs_ro: number | undefined = undefined;
  @Local lastUpdateTime: string = '--:--:--';
  @Local sampleCount: number = 0;
  // è¶‹åŠ¿çŠ¶æ€
  @Local tempTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @Local humTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @Local luxTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @Local smokeTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @Local pressureTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @Local tempDiffTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  // å®šä½çŠ¶æ€
  @Local locationStatus: string = 'æœªè·å–å®šä½';
  @Local locationStatusColor: string = '#9ca3af';
  @Local locationLon: string = '--';
  @Local locationLat: string = '--';
  @Local locationExtra: string = '';
  @Local locationAvailable: boolean = false;
  @Local showLocationMap: boolean = false;
  @Local isQueryingLocation: boolean = false;
  // ä¸šåŠ¡é€»è¾‘å®ä¾‹ï¼ˆè´Ÿè´£ WebSocket ä¸æ•°æ®å¤„ç†ï¼‰
  private logic: DeviceDetailPageLogic | null = null;
  // H5 åœ°å›¾ Web æ§åˆ¶å™¨
  private mapWebController: webview.WebviewController = new webview.WebviewController();
  // å›¾è¡¨ Web æ§åˆ¶å™¨
  private chartsWebController: webview.WebviewController = new webview.WebviewController();

  // ç”Ÿæˆ H5 åœ°å›¾é¡µé¢çš„åœ°å€ï¼ˆé€šè¿‡ query ä¼ å…¥ç»çº¬åº¦ï¼‰
  private getLocationMapUrl(): string {
    const baseUrl: string = 'resource://RAWFILE/location_map.html';
    if (!this.locationAvailable) {
      return baseUrl;
    }
    const lonNum: number = Number.parseFloat(this.locationLon);
    const latNum: number = Number.parseFloat(this.locationLat);
    if (Number.isNaN(lonNum) || Number.isNaN(latNum)) {
      return baseUrl;
    }
    // åªä¼ ç»çº¬åº¦ï¼Œå…¶ä»–ä¿¡æ¯åœ¨å¡ç‰‡ä¸­å±•ç¤º
    return `${baseUrl}?lon=${lonNum}&lat=${latNum}`;
  }

  // å‘é€å®šä½æŸ¥è¯¢å‘½ä»¤ï¼ˆHTTP è°ƒç”¨åç«¯ /api/location/queryï¼‰
  private async sendLocationQuery(): Promise<void> {
    if (this.isQueryingLocation) {
      return;
    }

    this.isQueryingLocation = true;
    this.locationStatus = 'æ­£åœ¨è·å–å®šä½...';
    this.locationStatusColor = '#f59e0b';

    const httpRequest: http.HttpRequest = http.createHttp();

    try {
      const url: string = `http://${SERVER_HOST}/api/location/query`;
      const response: http.HttpResponse = await httpRequest.request(url, {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json'
        }
      });

      let isOk: boolean = false;
      if (response && response.responseCode === 200) {
        // å¦‚æœåç«¯è¿”å› JSONï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŒ‰éœ€è§£æ
        // è¿™é‡Œä¸ºäº†é¿å… any/unknownï¼Œä»…æ ¹æ®çŠ¶æ€ç åˆ¤æ–­æˆåŠŸ
        isOk = true;
      }

      if (!isOk) {
        this.locationStatus = 'è·å–å¤±è´¥';
        this.locationStatusColor = '#ef4444';
      }
      // æˆåŠŸçš„æƒ…å†µï¼šä¿æŒâ€œæ­£åœ¨è·å–å®šä½...â€ï¼Œç­‰å¾… WebSocket æ¨é€ location æ•°æ®æ¥æ›´æ–° UI
    } catch {
      console.error('å®šä½æŸ¥è¯¢è¯·æ±‚å¤±è´¥');
      this.locationStatus = 'è¯·æ±‚å¤±è´¥';
      this.locationStatusColor = '#ef4444';
    } finally {
      httpRequest.destroy();
      this.isQueryingLocation = false;
    }
  }

  // æ›´æ–°å›¾è¡¨æ•°æ®ï¼ˆç”±Logicå±‚è°ƒç”¨ï¼‰
  updateCharts(timestamp: number, temp: number, hum: number, lux: number, smoke: number, pressure: number): void {
    try {
      // æ„é€ JavaScriptè°ƒç”¨å­—ç¬¦ä¸²
      const jsCode = `addDataPoint(${timestamp}, ${temp}, ${hum}, ${lux || 0}, ${smoke || 0}, ${pressure || 0})`;
      // æ‰§è¡ŒJavaScript
      this.chartsWebController.runJavaScript(jsCode);
    } catch (err) {
      console.error('æ›´æ–°å›¾è¡¨å¤±è´¥:', err);
    }
  }

  // æ›´æ–°å›¾è¡¨ä¸»é¢˜
  updateChartsTheme(): void {
    try {
      // ä»AppStorageè·å–å½“å‰é¢œè‰²æ¨¡å¼
      const currentMode = AppStorage.get<number>('currentColorMode');
      const isDarkMode = currentMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK;
      console.info(`æ›´æ–°å›¾è¡¨ä¸»é¢˜: ${isDarkMode ? 'æš—è‰²' : 'äº®è‰²'}`);
      // è°ƒç”¨Webç«¯çš„setThemeæ–¹æ³•
      const jsCode = `setTheme(${isDarkMode})`;
      this.chartsWebController.runJavaScript(jsCode);
    } catch (err) {
      console.error('æ›´æ–°å›¾è¡¨ä¸»é¢˜å¤±è´¥:', err);
    }
  }

  // ç”Ÿå‘½å‘¨æœŸå‡½æ•°
  aboutToAppear() {
    console.info(`DeviceDetailPage aboutToAppear - deviceId: ${this.deviceId}`);
    if (this.logic === null) {
      // å…ˆåˆ›å»ºLogicï¼ŒdeviceIdç¨ååœ¨onReadyä¸­è®¾ç½®
      this.logic = new DeviceDetailPageLogic(this);
    }
    
    // è®¢é˜…ä¸»é¢˜å˜åŒ–äº‹ä»¶
    try {
      emitter.on({ eventId: 1001 }, () => {
        console.info('æ”¶åˆ°ä¸»é¢˜å˜åŒ–äº‹ä»¶ï¼Œæ›´æ–°å›¾è¡¨');
        this.updateChartsTheme();
      });
    } catch (err) {
      console.error('è®¢é˜…ä¸»é¢˜å˜åŒ–äº‹ä»¶å¤±è´¥:', err);
    }
    // æ³¨æ„ï¼šè¿™é‡Œæš‚ä¸è°ƒç”¨ aboutToAppearï¼Œç­‰è·å–åˆ° deviceId åå†è¿æ¥
  }

  aboutToDisappear() {
    // å–æ¶ˆè®¢é˜…ä¸»é¢˜å˜åŒ–äº‹ä»¶
    try {
      emitter.off(1001);
    } catch (err) {
      console.error('å–æ¶ˆè®¢é˜…ä¸»é¢˜å˜åŒ–äº‹ä»¶å¤±è´¥:', err);
    }
    
    if (this.logic) {
      this.logic.aboutToDisappear();
    }
  }

  // è‡ªå®šä¹‰æ ‡é¢˜æ ç»„ä»¶
  @Builder
  CustomNavBar() {
    Stack({ alignContent: Alignment.Center }) {
      // å·¦ä¾§è¿”å›æŒ‰é’®
      Row() {
        Image($r("app.media.ic_back"))
          .height("100%")
          // .fillColor($r("app.color.home_title_text"))

      }
      .width(30)
      .height(30)
      .borderRadius(15)
      // .backgroundColor(Color.Red)
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)
      .position({ x: 10, y: 10 }) // ç»å¯¹å®šä½åœ¨å·¦ä¾§
      .onClick(() => {
        this.pageStack.pop();
      })
      .zIndex(10) // ç¡®ä¿åœ¨æœ€ä¸Šå±‚ï¼Œå¯ç‚¹å‡»

      // 2. ä¸­é—´å†…å®¹ï¼šLogo + æ ‡é¢˜
      Row({ space: 5 }) { // ä½¿ç”¨ Row è®© Logo å’Œæ–‡å­—å¹¶æ’
        // Logo å›¾ç‰‡
        Image($r("app.media.logo"))
          .width(150)
          .objectFit(ImageFit.Contain) // ä¿æŒæ¯”ä¾‹å®Œæ•´æ˜¾ç¤º
          .autoResize(true)

        // æ ‡é¢˜æ–‡å­—
        Text(this.deviceName || "è®¾å¤‡è¯¦æƒ…")
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor($r("app.color.home_value_text"))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .margin({ right: 20 })
      .height('100%')
      .justifyContent(FlexAlign.Center) // æ•´ä½“å±…ä¸­
      .alignItems(VerticalAlign.Center)
      .width('70%') // é™åˆ¶ä¸­é—´åŒºåŸŸå®½åº¦ï¼Œé˜²æ­¢é®æŒ¡ä¸¤è¾¹
      .hitTestBehavior(HitTestMode.None) // ä¸­é—´åŒºåŸŸä¸æ‹¦æˆªç‚¹å‡»ï¼Œè™½ç„¶è¿™é‡Œæ²¡æœ‰äº¤äº’ï¼Œä½†æ˜¯å¥½ä¹ æƒ¯
    }
    .width('100%')
    .height(45) // å¯¼èˆªæ é«˜åº¦
  }

  build() {
    NavDestination() {
      Column() {
        // æ ‡é¢˜æ 
        // Row() {
        //   Image($r("app.media.logo"))
        //     .width(150)
        //   Text("æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ")
        //     .fontWeight(FontWeight.Bolder)
        //     .fontSize(20)
        // }
        // .justifyContent(FlexAlign.Center)
        // .width("100%")
        // .margin({ bottom: 10, right: 20 })

        // æ’å…¥è‡ªå®šä¹‰æ ‡é¢˜æ 
        this.CustomNavBar()

        // çŠ¶æ€æ 
        Row({ space: 10 }) {
          // è¿æ¥çŠ¶æ€
          Row({ space: 5 }) {
            Row()
              .backgroundColor(this.wsConnected ? "#4CA154" : "#E53E3E")
              .width(12)
              .height(12)
              .borderRadius(100)
            Text(this.wsConnected ? "å·²è¿æ¥" : "æœªè¿æ¥")
              .fontColor($r("app.color.home_status_text"))
              .fontSize(12)
          }
          .padding({
            left: 10,
            right: 10,
            top: 5,
            bottom: 5
          })
          .borderColor($r("app.color.home_border"))
          .borderWidth(1)
          .borderRadius(30)

          // ä¸Šæ¬¡æ›´æ–°
          Row({ space: 5 }) {
            Text(`ä¸Šæ¬¡æ›´æ–°: ${this.lastUpdateTime}`)
              .fontColor($r("app.color.home_status_text"))
              .fontSize(12)
          }
          .padding({
            left: 10,
            right: 10,
            top: 5,
            bottom: 5
          })
          .borderColor($r("app.color.home_border"))
          .borderWidth(1)
          .borderRadius(30)

          // æ ·æœ¬æ•°
          Row({ space: 5 }) {
            Text(`æ ·æœ¬æ•°: ${this.sampleCount}`)
              .fontColor($r("app.color.home_status_text"))
              .fontSize(12)
          }
          .padding({
            left: 10,
            right: 10,
            top: 5,
            bottom: 5
          })
          .borderColor($r("app.color.home_border"))
          .borderWidth(1)
          .borderRadius(30)
        }
        .width("100%")
        .justifyContent(FlexAlign.Center)
        // .backgroundColor(Color.Red)
        .padding({ left: 10, right: 10 })

        Scroll() {
          Column({ space: 15 }) {
            // ä¼ æ„Ÿå™¨æ•°æ®å±•ç¤ºåŒºåŸŸï¼ˆGrid ä¸‰åˆ—ä¸¤è¡Œï¼‰
            Grid() {
              // æ¸©åº¦
              GridItem() {
                MetricCard({
                  title: "æ¸©åº¦",
                  valueText: `${this.temp !== undefined && this.temp !== null ? this.temp.toFixed(2) : '--'} â„ƒ`,
                  trend: this.tempTrend,
                  valueFontSize: 24
                })
              }

              // æ¸©å·® Î”
              GridItem() {
                MetricCard({
                  title: "æ¸©åº¦ Î”",
                  valueText: `${this.temp !== undefined && this.temp !== null && this.temp2 !== undefined &&
                    this.temp2 !== null ? Math.abs(this.temp - this.temp2).toFixed(2) : '--'} â„ƒ`,
                  trend: this.tempDiffTrend,
                  valueFontSize: 24
                })
              }

              // æ¹¿åº¦
              GridItem() {
                MetricCard({
                  title: "æ¹¿åº¦",
                  valueText: `${this.hum !== undefined && this.hum !== null ? this.hum.toFixed(2) : '--'} %`,
                  trend: this.humTrend,
                  valueFontSize: 24
                })
              }

              // äº®åº¦
              GridItem() {
                MetricCard({
                  title: "äº®åº¦",
                  valueText: `${this.lux !== undefined && this.lux !== null ? this.lux.toFixed(1) : '--'} lux`,
                  trend: this.luxTrend,
                  valueFontSize: 24
                })
              }

              // çƒŸé›¾
              GridItem() {
                MetricCard({
                  title: "çƒŸé›¾",
                  valueText: `${this.smoke !== undefined && this.smoke !== null ? this.smoke.toFixed(1) : '--'} ppm`,
                  trend: this.smokeTrend,
                  valueFontSize: 24
                })
              }

              // å¤§æ°”å‹
              GridItem() {
                MetricCard({
                  title: "å¤§æ°”å‹",
                  valueText: `${this.pressure !== undefined && this.pressure !== null ? this.pressure.toFixed(1) :
                    '--'} hPa`,
                  trend: this.pressureTrend,
                  valueFontSize: 22
                })
              }
            }
            .columnsTemplate("1fr 1fr")
            // .rowsTemplate("auto auto auto")
            .columnsGap(12)
            .rowsGap(12)
            .constraintSize({ maxWidth: 600 })
            .width("100%")
            .padding({
              // left: 15,
              // right: 15,
              top: 15
            })

            // å®šä½ä¿¡æ¯å¡ç‰‡
            Column() {
              Row({ space: 8 }) {
                Text("ğŸ“ è®¾å¤‡å®šä½")
                  .fontWeight(FontWeight.Bolder)
                  .fontSize(16)
                  .fontColor($r("app.color.home_value_text"))
                Text(this.locationStatus)
                  .fontColor(this.locationStatusColor)
                  .fontSize(12)
                  .margin({ left: 8 })
              }
              .width("100%")

              if (this.locationAvailable) {
                Grid() {
                  GridItem() {
                    Column({ space: 4 }) {
                      Text("ç»åº¦")
                        .fontSize(12)
                        .fontColor($r("app.color.home_status_text"))
                      Text(this.locationLon)
                        .fontSize(22)
                        .fontWeight(FontWeight.Bolder)
                        .fontColor($r("app.color.home_value_text"))
                    }
                  }

                  GridItem() {
                    Column({ space: 4 }) {
                      Text("çº¬åº¦")
                        .fontSize(12)
                        .fontColor($r("app.color.home_status_text"))
                      Text(this.locationLat)
                        .fontSize(22)
                        .fontWeight(FontWeight.Bolder)
                        .fontColor($r("app.color.home_value_text"))
                    }
                  }
                }
                .columnsTemplate("1fr 1fr")
                .columnsGap(12)
                .margin({ top: 10 })
              } else {
                Text("ç­‰å¾…æœåŠ¡å™¨æ¨é€å®šä½æ•°æ®...")
                  .fontSize(12)
                  .fontColor($r("app.color.home_status_text"))
                  .margin({ top: 10 })
              }

              if (this.locationExtra && this.locationExtra.length > 0) {
                Text(this.locationExtra)
                  .fontSize(12)
                  .fontColor($r("app.color.home_status_text"))
                  .margin({ top: 8 })
              }

              // å‘é€å®šä½æŒ‰é’® + åœ°å›¾å¼€å…³
              Row({ space: 8 }) {
                Button(this.isQueryingLocation ? "â³ æ­£åœ¨è·å–å®šä½..." : "ğŸ“ å‘é€å®šä½")
                  .fontSize(12)
                  .fontColor(Color.White)
                  .backgroundColor('#2563eb')
                  .borderRadius(8)
                  .padding({
                    left: 10,
                    right: 10,
                    top: 6,
                    bottom: 6
                  })
                  .enabled(!this.isQueryingLocation)
                  .onClick(() => {
                    if (this.isQueryingLocation) {
                      return;
                    }
                    this.sendLocationQuery();
                    // ä¸»åŠ¨å±•å¼€åœ°å›¾ï¼Œç­‰å¾…å®šä½ç»“æœ
                    if (!this.showLocationMap) {
                      this.showLocationMap = true;
                    }
                  })

                Button(this.showLocationMap ? "ğŸ—º æ”¶èµ·åœ°å›¾" : "ğŸ—º æ˜¾ç¤ºåœ°å›¾")
                  .fontSize(12)
                  .fontColor(Color.White)
                  .backgroundColor(this.locationAvailable ? '#2563eb' : '#4b5563')
                  .borderRadius(8)
                  .padding({
                    left: 10,
                    right: 10,
                    top: 6,
                    bottom: 6
                  })
                  .enabled(this.locationAvailable)
                  .onClick(() => {
                    if (!this.locationAvailable) {
                      return;
                    }
                    this.showLocationMap = !this.showLocationMap;
                  })
              }
              .margin({ top: 10 })

              if (this.locationAvailable) {
                // å§‹ç»ˆæ¸²æŸ“åœ°å›¾å®¹å™¨ï¼Œé€šè¿‡é«˜åº¦å’Œé€æ˜åº¦é…åˆ animation å®ç°è¿‡æ¸¡åŠ¨ç”»
                Column() {
                  Web({
                    src: this.getLocationMapUrl(),
                    controller: this.mapWebController
                  })
                    .javaScriptAccess(true)
                    .width('100%')
                    .height('100%')
                }
                .width('100%')
                .height(this.showLocationMap ? 260 : 0)
                .opacity(this.showLocationMap ? 1 : 0)
                .margin({ top: 12 })
                .animation({
                  duration: 250,
                  curve: Curve.EaseInOut
                })
              }
            }
            .constraintSize({ maxWidth: 600 })
            .width("100%")
            .padding({
              left: 12,
              right: 12,
              top: 12,
              bottom: 12
            })
            .borderColor($r("app.color.home_card_border"))
            .borderWidth(1)
            .backgroundColor($r("app.color.home_card_background"))
            .borderRadius(12)
            .shadow({
              radius: 8,
              color: '#1F000000',
              offsetX: 0,
              offsetY: 2
            })

            // æ•°æ®å›¾è¡¨åŒºåŸŸ
            Column() {
              Web({
                src: 'resource://RAWFILE/charts.html',
                controller: this.chartsWebController
              })
                .javaScriptAccess(true)
                .domStorageAccess(true)
                .width('100%')
                .height(1200) // 4ä¸ªå›¾è¡¨ï¼Œæ¯ä¸ªçº¦200pxé«˜ + é—´è·
                .backgroundColor(Color.Transparent)
                .onPageEnd(() => {
                  // é¡µé¢åŠ è½½å®Œæˆåï¼Œç«‹å³è®¾ç½®ä¸»é¢˜
                  console.info('å›¾è¡¨é¡µé¢åŠ è½½å®Œæˆï¼Œè®¾ç½®åˆå§‹ä¸»é¢˜');
                  setTimeout(() => {
                    this.updateChartsTheme();
                  }, 100); // å»¶è¿Ÿ100msç¡®ä¿å›¾è¡¨å·²åˆå§‹åŒ–
                })
            }
            .constraintSize({ maxWidth: 600 })
            .width("100%")
          }
        }
        .width("100%")
        .padding({ bottom: 100, left: 15, right: 15 })
      }
      .backgroundColor($r("app.color.home_background"))
      .width("100%")
      .height("100%")
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    }
    .hideTitleBar(true) // 4. å½»åº•éšè—ç³»ç»Ÿæ ‡é¢˜æ ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„ CustomNavBar
    // 5. åœ¨ onReady ä¸­è·å–å‚æ•°
    .onReady((context: NavDestinationContext) => {
      const params = context.pathInfo.param as Record<string, string>;
      if (params) {
        if (params['deviceId']) {
          this.deviceId = params['deviceId'];
          console.info(`DeviceDetailPage onReady - è·å–åˆ° deviceId: ${this.deviceId}`);
        }
        if (params['deviceName']) {
          this.deviceName = params['deviceName'];
          console.info(`DeviceDetailPage onReady - è·å–åˆ° deviceName: ${this.deviceName}`);
        }
      }
      
      // å¦‚æœAppStorageä¸­æ²¡æœ‰é¢œè‰²æ¨¡å¼ï¼Œä½¿ç”¨é»˜è®¤å€¼
      if (!AppStorage.has('currentColorMode')) {
        AppStorage.setOrCreate('currentColorMode', ConfigurationConstant.ColorMode.COLOR_MODE_LIGHT);
      }
      
      // è·å–å‚æ•°åï¼Œè®¾ç½®deviceIdå¹¶å¯åŠ¨WebSocketè¿æ¥
      if (this.logic && this.deviceId) {
        this.logic.setDeviceId(this.deviceId);
        this.logic.aboutToAppear();
      } else {
        console.error('Logicæœªåˆå§‹åŒ–æˆ–deviceIdä¸ºç©º');
      }
    })
  }
}


// å¯¼å‡º Builder ç»™ route_map.json ä½¿ç”¨
@Builder
export function DeviceDetailPageBuilder() {
  DeviceDetailPage()
}