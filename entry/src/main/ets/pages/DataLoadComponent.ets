import http from '@ohos.net.http';
import promptAction from '@ohos.promptAction';
import { SensorData, SERVER_HOST } from './DeviceDetailPageLogic';

// åŠ è½½æ–¹å¼æšä¸¾
export enum LoadMode {
  COUNT, // æŒ‰æ¡æ•°
  TIME, // æŒ‰æ—¶é—´æ®µ
  RANGE, // è‡ªå®šä¹‰èŒƒå›´
  ALL // å…¨éƒ¨æ•°æ®
}

// æ—¶é—´å•ä½æšä¸¾
export enum TimeUnit {
  MINUTE = 'minute',
  HOUR = 'hour',
  DAY = 'day',
  MONTH = 'month'
}

// åŠ è½½å‚æ•°æ¥å£
export interface LoadParams {
  mode: LoadMode;
  count?: number; // æŒ‰æ¡æ•°ï¼šæ•°æ®æ¡æ•°
  timeValue?: number; // æŒ‰æ—¶é—´ï¼šæ—¶é—´æ•°é‡
  timeUnit?: TimeUnit; // æŒ‰æ—¶é—´ï¼šæ—¶é—´å•ä½
  startTime?: number; // æŒ‰èŒƒå›´ï¼šå¼€å§‹æ—¶é—´æˆ³
  endTime?: number; // æŒ‰èŒƒå›´ï¼šç»“æŸæ—¶é—´æˆ³
}

// åŠ è½½ç»“æœå›è°ƒæ¥å£
export interface DataLoadCallback {
  onDataLoaded: (data: SensorData[], count: number) => void;
  onLoadError?: (error: string) => void;
}

// æ•°æ®åŠ è½½å™¨ç±»
export class DataLoader {
  private deviceId: string;
  private callback: DataLoadCallback;

  constructor(deviceId: string, callback: DataLoadCallback) {
    this.deviceId = deviceId;
    this.callback = callback;
  }

  // æ‰§è¡Œæ•°æ®åŠ è½½
  async load(params: LoadParams): Promise<void> {
    try {
      let url = `http://${SERVER_HOST}/api/history`;
      const queryParams: string[] = [`device_id=${this.deviceId}`];

      switch (params.mode) {
        case LoadMode.COUNT:
          // æŒ‰æ¡æ•°åŠ è½½
          if (params.count !== undefined && params.count > 0) {
            queryParams.push(`limit=${params.count}`);
          }
          break;

        case LoadMode.TIME:
          // æŒ‰æ—¶é—´æ®µåŠ è½½
          if (params.timeValue !== undefined && params.timeUnit !== undefined) {
            const now = Date.now() / 1000;
            let startTime = now;

            switch (params.timeUnit) {
              case TimeUnit.MINUTE:
                startTime = now - params.timeValue * 60;
                break;
              case TimeUnit.HOUR:
                startTime = now - params.timeValue * 3600;
                break;
              case TimeUnit.DAY:
                startTime = now - params.timeValue * 86400;
                break;
              case TimeUnit.MONTH:
                startTime = now - params.timeValue * 2592000; // 30å¤©
                break;
            }

            url = `http://${SERVER_HOST}/api/history/range`;
            queryParams.push(`start=${startTime}`);
            queryParams.push(`end=${now}`);
          }
          break;

        case LoadMode.RANGE:
          // è‡ªå®šä¹‰æ—¶é—´èŒƒå›´
          if (params.startTime !== undefined && params.endTime !== undefined) {
            url = `http://${SERVER_HOST}/api/history/range`;
            queryParams.push(`start=${params.startTime}`);
            queryParams.push(`end=${params.endTime}`);
          }
          break;

        case LoadMode.ALL:
          // åŠ è½½å…¨éƒ¨æ•°æ®
          queryParams.push('limit=-1');
          break;
      }

      // æ‹¼æ¥æŸ¥è¯¢å‚æ•°
      url += '?' + queryParams.join('&');

      console.info(`å¼€å§‹åŠ è½½æ•°æ®: ${url}`);

      const httpRequest: http.HttpRequest = http.createHttp();
      const response: http.HttpResponse = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json'
        }
      });

      httpRequest.destroy();

      if (response && response.responseCode === 200) {
        const result = JSON.parse(response.result as string) as Record<string, Object>;

        if (result['success'] === true && result['data']) {
          const dataArray = result['data'] as Array<Record<string, Object>>;
          console.info(`æˆåŠŸåŠ è½½ ${dataArray.length} æ¡æ•°æ®`);

          // è½¬æ¢ä¸º SensorData æ•°ç»„
          const historyData: SensorData[] = [];
          dataArray.forEach((item: Record<string, Object>) => {
            if (item['type'] === 'reading') {
              historyData.push({
                ts: item['ts'] as number,
                temp: item['temp'] as number,
                hum: item['hum'] as number,
                lux: item['lux'] as number,
                smoke: item['smoke'] as number,
                pressure: item['pressure'] as number,
                temp2: item['temp2'] as number,
                rs_ro: item['rs_ro'] as number
              });
            }
          });

          // å›è°ƒé€šçŸ¥æ•°æ®åŠ è½½å®Œæˆ
          this.callback.onDataLoaded(historyData, historyData.length);
        } else {
          const error = 'æ•°æ®åŠ è½½å¤±è´¥æˆ–æ— æ•°æ®';
          console.error(error);
          if (this.callback.onLoadError) {
            this.callback.onLoadError(error);
          }
        }
      } else {
        const error = `HTTPè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response?.responseCode}`;
        console.error(error);
        if (this.callback.onLoadError) {
          this.callback.onLoadError(error);
        }
      }
    } catch (err) {
      const error = `æ•°æ®åŠ è½½å¼‚å¸¸: ${err}`;
      console.error(error);
      if (this.callback.onLoadError) {
        this.callback.onLoadError(error);
      }
    }
  }
}

// æ•°æ®åŠ è½½æµ®åŠ¨æŒ‰é’®å’Œå¼¹çª—ç»„ä»¶
@ComponentV2
export struct DataLoadFloatButton {
  @Require @Param deviceId: string;
  @Require @Param onDataLoaded: (data: SensorData[], count: number) => void;
  // å…è®¸çˆ¶ç»„ä»¶ä¼ å…¥è¾¹è·ï¼Œé»˜è®¤å€¼è®¾ä¸º 20 å’Œ 40
  @Param rightMargin: number = 20;
  @Param bottomMargin: number = 40;

  @Local showLoadPanel: boolean = false;
  @Local showModeSelection: boolean = true; // æ˜¯å¦æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©ç•Œé¢
  @Local selectedMode: LoadMode = LoadMode.COUNT;
  @Local loadCount: number = 1000;
  @Local timeValue: number = 1;
  @Local timeUnit: TimeUnit = TimeUnit.HOUR;
  @Local startDate: Date = new Date(Date.now() - 86400000); // é»˜è®¤æ˜¨å¤©
  @Local endDate: Date = new Date();
  @Local isLoading: boolean = false;

  // æ•°æ®åŠ è½½å™¨
  private loader: DataLoader | null = null;

  aboutToAppear(): void {
    this.loader = new DataLoader(this.deviceId, {
      onDataLoaded: (data: SensorData[], count: number) => {
        this.isLoading = false;
        this.showLoadPanel = false;
        this.showModeSelection = true; // é‡ç½®çŠ¶æ€
        try {
          promptAction.showToast({ message: `æˆåŠŸåŠ è½½ ${count} æ¡æ•°æ®`, duration: 2000 });
        } catch (e) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', e);
        }
        this.onDataLoaded(data, count);
      },
      onLoadError: (error: string) => {
        this.isLoading = false;
        try {
          promptAction.showToast({ message: `åŠ è½½å¤±è´¥: ${error}`, duration: 2000 });
        } catch (e) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', e);
        }
      }
    });
  }

  // æ‰§è¡ŒåŠ è½½
  private async executeLoad(): Promise<void> {
    if (this.isLoading || !this.loader) {
      return;
    }

    this.isLoading = true;

    const params: LoadParams = { mode: this.selectedMode };

    switch (this.selectedMode) {
      case LoadMode.COUNT:
        params.count = this.loadCount;
        break;
      case LoadMode.TIME:
        params.timeValue = this.timeValue;
        params.timeUnit = this.timeUnit;
        break;
      case LoadMode.RANGE:
        params.startTime = Math.floor(this.startDate.getTime() / 1000);
        params.endTime = Math.floor(this.endDate.getTime() / 1000);
        break;
      case LoadMode.ALL:
        // æ— éœ€é¢å¤–å‚æ•°
        break;
    }

    await this.loader.load(params);
  }

  build() {
    // æ ¹å®¹å™¨ Stack
    // æ ¸å¿ƒä¿®å¤é€»è¾‘ï¼š
    // å½“ showLoadPanel ä¸º false æ—¶ï¼Œå®½é«˜è®¾ä¸º autoï¼Œæ­¤æ—¶ Stack å¤§å° = æŒ‰é’®å¤§å° + Marginã€‚
    // ç”±äºåœ¨çˆ¶ç»„ä»¶ä¸­ä½¿ç”¨äº† Stack(BottomEnd)ï¼Œè¿™ä¸ªå°å°çš„ Stack ä¼šè¢«è‡ªåŠ¨å¯¹é½åˆ°å³ä¸‹è§’ï¼Œå®Œå…¨ä¸å½±å“é¡µé¢å…¶ä»–åŒºåŸŸã€‚
    // å½“ showLoadPanel ä¸º true æ—¶ï¼Œå®½é«˜è®¾ä¸º 100%ï¼Œè¦†ç›–å…¨å±æ˜¾ç¤ºé®ç½©ã€‚
    Stack({ alignContent: Alignment.BottomEnd }) {

      // 1. åŠ è½½é¢æ¿ (Overlay)
      if (this.showLoadPanel) {
        // èƒŒæ™¯é®ç½©å±‚
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#40000000')
          .onClick(() => {
            this.showLoadPanel = false;
          })
          .zIndex(998)

        // é¢æ¿ä¸»ä½“
        Column() {
          // æ ‡é¢˜æ 
          Row() {
            Text("ğŸ“Š åŠ è½½å†å²æ•°æ®")
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r("app.color.home_value_text"))
              .layoutWeight(1)

            Text("âœ•")
              .fontSize(24)
              .fontColor($r("app.color.home_status_text"))
              .onClick(() => {
                this.showLoadPanel = false;
              })
          }
          .width('100%')
          .padding(16)
          .borderColor($r("app.color.home_card_border"))
          .borderWidth({ bottom: 1 })

          Scroll() {
            Column({ space: 12 }) {
              if (this.showModeSelection) {
                this.buildModeSelection()
              } else if (this.selectedMode === LoadMode.COUNT) {
                this.buildCountForm()
              } else if (this.selectedMode === LoadMode.TIME) {
                this.buildTimeForm()
              } else if (this.selectedMode === LoadMode.RANGE) {
                this.buildRangeForm()
              }
            }
            .padding(16)
          }
          .layoutWeight(1)

          // åº•éƒ¨æŒ‰é’®
          Row({ space: 12 }) {
            if (this.showModeSelection) {
              Button("å–æ¶ˆ")
                .fontSize(14)
                .fontColor($r("app.color.home_value_text"))
                .backgroundColor($r("app.color.home_card_background"))
                .borderWidth(1)
                .borderColor($r("app.color.home_card_border"))
                .layoutWeight(1)
                .onClick(() => {
                  this.showLoadPanel = false;
                })
            } else {
              Button("è¿”å›")
                .fontSize(14)
                .fontColor($r("app.color.home_value_text"))
                .backgroundColor($r("app.color.home_card_background"))
                .borderWidth(1)
                .borderColor($r("app.color.home_card_border"))
                .layoutWeight(1)
                .onClick(() => {
                  this.showModeSelection = true;
                })

              Button(this.isLoading ? "åŠ è½½ä¸­..." : "åŠ è½½æ•°æ®")
                .fontSize(14)
                .fontColor(Color.White)
                .backgroundColor('#2563eb')
                .layoutWeight(1)
                .enabled(!this.isLoading)
                .onClick(() => {
                  this.executeLoad();
                })
            }
          }
          .width('100%')
          .padding(16)
          .borderColor($r("app.color.home_card_border"))
          .borderWidth({ top: 1 })
        }
        .width('90%')
        .constraintSize({ maxWidth: 400 })
        .height('80%')
        .constraintSize({ maxHeight: 600 })
        .backgroundColor($r("app.color.home_card_background"))
        .borderRadius(16)
        .shadow({
          radius: 20,
          color: '#3F000000',
          offsetX: 0,
          offsetY: 8
        })
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .zIndex(999)
        .margin({right:"5%",bottom:"15%"})
      }

      // 2. æ‚¬æµ®æŒ‰é’® (ä»…åœ¨é¢æ¿å…³é—­æ—¶æ˜¾ç¤ºï¼Œæˆ–è€…ä¸€ç›´æ˜¾ç¤ºçœ‹éœ€æ±‚)
      if (!this.showLoadPanel) {
        Column() {
          Image($r("app.media.ic_loading"))
            .width(28)
            .height(28)
            .fillColor(Color.White)
        }
        .width(56)
        .height(56)
        .borderRadius(28)
        .backgroundColor('#2563eb')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .shadow({
          radius: 12,
          color: '#4f2563eb',
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => {
          this.showLoadPanel = true;
          this.showModeSelection = true;
        })
        // åœ¨è¿™é‡Œä½¿ç”¨ä¼ å…¥çš„ margin å‚æ•°
        .margin({ right: this.rightMargin, bottom: this.bottomMargin })
      }
    }
    // å…³é”®æ”¹åŠ¨ï¼šå°ºå¯¸æ¡ä»¶æ§åˆ¶ã€‚é¢æ¿æ‰“å¼€æ—¶å æ»¡å…¨å±ï¼Œå…³é—­æ—¶æ”¶ç¼©ä¸ºå†…å®¹å¤§å°ã€‚
    .width(this.showLoadPanel ? '100%' : 'auto')
    .height(this.showLoadPanel ? '100%' : 'auto')
  }

  // æ¨¡å¼é€‰æ‹©ç•Œé¢
  @Builder
  buildModeSelection() {
    Column({ space: 12 }) {
      this.buildModeOption('ğŸ“', 'æŒ‰æœ€è¿‘æ¡æ•°åŠ è½½', 'åŠ è½½æœ€è¿‘çš„Næ¡æ•°æ®è®°å½•', () => {
        this.selectedMode = LoadMode.COUNT;
        this.showModeSelection = false;
      })
      this.buildModeOption('â±ï¸', 'æŒ‰æœ€è¿‘æ—¶é—´åŠ è½½', 'åŠ è½½æœ€è¿‘å‡ åˆ†é’Ÿ/å°æ—¶/å¤©/æœˆçš„æ•°æ®', () => {
        this.selectedMode = LoadMode.TIME;
        this.showModeSelection = false;
      })
      this.buildModeOption('ğŸ“…', 'è‡ªå®šä¹‰æ—¶é—´èŒƒå›´', 'é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œç²¾ç¡®åŠ è½½', () => {
        this.selectedMode = LoadMode.RANGE;
        this.showModeSelection = false;
      })
      this.buildModeOption('âš ï¸', 'åŠ è½½å…¨éƒ¨æ•°æ®', 'åŠ è½½æ•°æ®åº“ä¸­çš„æ‰€æœ‰å†å²æ•°æ®ï¼ˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰', () => {
        this.selectedMode = LoadMode.ALL;
        this.showModeSelection = false;
        this.executeLoad();
      })
    }
  }

  // æ¨¡å¼é€‰é¡¹ç»„ä»¶
  @Builder
  buildModeOption(icon: string, title: string, desc: string, onClick: () => void) {
    Column({ space: 8 }) {
      Row({ space: 8 }) {
        Text(icon).fontSize(20)
        Text(title)
          .fontSize(15)
          .fontWeight(FontWeight.Medium)
          .fontColor($r("app.color.home_value_text"))
      }
      .width('100%')
      Text(desc)
        .fontSize(12)
        .fontColor($r("app.color.home_status_text"))
        .width('100%')
    }
    .width('100%')
    .padding(16)
    .borderRadius(12)
    .borderWidth(1)
    .borderColor($r("app.color.home_card_border"))
    .backgroundColor($r("app.color.home_card_background"))
    .onClick(onClick)
  }

  // æŒ‰æ¡æ•°åŠ è½½è¡¨å•
  @Builder
  buildCountForm() {
    Column({ space: 16 }) {
      Text("æ•°æ®æ¡æ•°").fontSize(14).fontColor($r("app.color.home_title_text")).width('100%')
      Row({ space: 8 }) {
        TextInput({ text: this.loadCount.toString() })
          .type(InputType.Number)
          .fontSize(14)
          .layoutWeight(1)
          .onChange((value: string) => {
            const num = parseInt(value);
            if (!isNaN(num) && num > 0) this.loadCount = num;
          })
        Text("æ¡").fontSize(14).fontColor($r("app.color.home_status_text"))
      }
      .width('100%')
    }
  }

  // æŒ‰æ—¶é—´æ®µåŠ è½½è¡¨å•
  @Builder
  buildTimeForm() {
    Column({ space: 16 }) {
      Text("æ—¶é—´æ•°é‡").fontSize(14).fontColor($r("app.color.home_title_text")).width('100%')
      Row({ space: 8 }) {
        TextInput({ text: this.timeValue.toString() })
          .type(InputType.Number)
          .fontSize(14)
          .width(100)
          .onChange((value: string) => {
            const num = parseInt(value);
            if (!isNaN(num) && num > 0) this.timeValue = num;
          })
        Select([
          { value: 'åˆ†é’Ÿ', icon: '' },
          { value: 'å°æ—¶', icon: '' },
          { value: 'å¤©', icon: '' },
          { value: 'æœˆ', icon: '' }
        ])
          .selected(1)
          .value(this.getTimeUnitText())
          .layoutWeight(1)
          .onSelect((index: number) => {
            switch (index) {
              case 0: this.timeUnit = TimeUnit.MINUTE; break;
              case 1: this.timeUnit = TimeUnit.HOUR; break;
              case 2: this.timeUnit = TimeUnit.DAY; break;
              case 3: this.timeUnit = TimeUnit.MONTH; break;
            }
          })
      }
      .width('100%')
    }
  }

  // è‡ªå®šä¹‰æ—¶é—´èŒƒå›´è¡¨å•
  @Builder
  buildRangeForm() {
    Column({ space: 16 }) {
      Column({ space: 8 }) {
        Text("å¼€å§‹æ—¶é—´").fontSize(14).fontColor($r("app.color.home_title_text")).width('100%')
        DatePicker({ start: new Date('2020-01-01'), end: new Date(), selected: this.startDate })
          .onDateChange((value: Date) => { this.startDate = value; })
      }
      Column({ space: 8 }) {
        Text("ç»“æŸæ—¶é—´").fontSize(14).fontColor($r("app.color.home_title_text")).width('100%')
        DatePicker({ start: new Date('2020-01-01'), end: new Date(), selected: this.endDate })
          .onDateChange((value: Date) => { this.endDate = value; })
      }
    }
  }

  private getTimeUnitText(): string {
    switch (this.timeUnit) {
      case TimeUnit.MINUTE: return 'åˆ†é’Ÿ';
      case TimeUnit.HOUR: return 'å°æ—¶';
      case TimeUnit.DAY: return 'å¤©';
      case TimeUnit.MONTH: return 'æœˆ';
      default: return 'å°æ—¶';
    }
  }
}