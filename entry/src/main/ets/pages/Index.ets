import { DevicesPage } from './DevicesPage';
import { AnalysisPage } from './AnalysisPage';
import { webview } from '@kit.ArkWeb';
import { ControlPage } from './ControlPage';

@Entry
@ComponentV2
struct Index {
  @Local currentIndex: number = 0;
  @Local showWebAnalysis: boolean = false; // æ˜¯å¦åœ¨åˆ†æTabä¸­æ˜¾ç¤ºWebç‰ˆæœ¬
  @Provider('pageStack') pageStack: NavPathStack = new NavPathStack();

  // å®šä¹‰ä¸»é¢˜è‰²ï¼Œæ–¹ä¾¿åæœŸç»Ÿä¸€ä¿®æ”¹
  public readonly selectedColor: string = "#007DFF"; // é€‰ä¸­é¢œè‰²ï¼ˆåä¸ºè“ï¼‰
  public readonly normalColor: string = "#999999";   // æœªé€‰ä¸­é¢œè‰²ï¼ˆç°è‰²ï¼‰
  
  // åŒå‡»æ£€æµ‹
  private lastClickTime: number = 0;
  private lastClickIndex: number = -1;
  private readonly DOUBLE_CLICK_INTERVAL: number = 500; // 500mså†…ç®—åŒå‡»
  
  // WebView æ§åˆ¶å™¨
  private webViewController: webview.WebviewController = new webview.WebviewController();
  
  aboutToAppear(): void {
    // é¡µé¢åŠ è½½æ—¶æ›´æ–°ä¸»é¢˜
    this.updateWebViewTheme();
  }

  build() {
    Navigation(this.pageStack) {
      Tabs({
        index: this.currentIndex,
        barPosition: BarPosition.End
      }) {
        // 1. é¦–é¡µ
        TabContent() {
          DevicesPage()
        }
        .tabBar(this.TabBuilder("é¦–é¡µ", 0, $r("app.media.ic_home")))

        // 2. æ§åˆ¶
        TabContent() {
          ControlPage()
        }
        .tabBar(this.TabBuilder("æ§åˆ¶", 1, $r("app.media.ic_control")))

        // 3. åˆ†æ
        TabContent() {
          if (this.showWebAnalysis) {
            this.buildWebAnalysisPage()
          } else {
            AnalysisPage()
          }
        }
        .tabBar(this.TabBuilder("AIÂ·åˆ†æ", 2, $r("app.media.ic_analysis")))

        // 4. æ¶ˆæ¯
        TabContent() {
          Text("æ¶ˆæ¯é¡µå†…å®¹").fontSize(30)
        }
        .tabBar(this.TabBuilder("æ¶ˆæ¯", 3, $r("app.media.ic_message")))

        // 5. å…³äº
        TabContent() {
          Text("å…³äºé¡µå†…å®¹").fontSize(30)
        }
        .tabBar(this.TabBuilder("å…³äº", 4, $r("app.media.ic_about")))
      }
      .backgroundColor($r("app.color.home_background"))
      .barHeight(56)
      .animationDuration(300) // æ¢å¤åˆ‡æ¢åŠ¨ç”»
      .onChange((index: number) => {
        this.currentIndex = index;
        // åˆ‡æ¢åˆ°å…¶ä»–Tabæ—¶ï¼Œè‡ªåŠ¨å›åˆ°åŸç”Ÿåˆ†æé¡µ
        // if (index !== 2 && this.showWebAnalysis) {
        //   this.showWebAnalysis = false;
        // }
      })
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
    }
    .hideTitleBar(true)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  // å¤„ç†Tabç‚¹å‡»
  private handleTabClick(targetIndex: number): void {
    console.info(`[Tabç‚¹å‡»] ç´¢å¼•: ${targetIndex}`);
    const currentTime = Date.now();
    
    // æ£€æµ‹åŒå‡»åˆ†ææŒ‰é’®ï¼ˆç´¢å¼•ä¸º1ï¼‰
    if (targetIndex === 2) {
      console.info(`[åˆ†æTab] ä¸Šæ¬¡ç‚¹å‡»: ${this.lastClickIndex}, æ—¶é—´é—´éš”: ${currentTime - this.lastClickTime}ms`);
      
      if (this.lastClickIndex === 2 &&
          this.currentIndex === 2 && // å¿…é¡»å·²ç»åœ¨åˆ†æé¡µ
          (currentTime - this.lastClickTime) < this.DOUBLE_CLICK_INTERVAL) {
        // åŒå‡»äº†åˆ†ææŒ‰é’®ï¼Œåˆ‡æ¢åˆ°Webç‰ˆ
        console.info('[åŒå‡»æ£€æµ‹] è§¦å‘åŒå‡»ï¼Œåˆ‡æ¢åˆ°Webç‰ˆæ•°æ®åˆ†æ');
        this.showWebAnalysis = true;
        // é‡ç½®è®¡æ—¶å™¨ï¼Œé¿å…è¿ç»­è§¦å‘
        this.lastClickTime = 0;
        this.lastClickIndex = -1;
        return;
      }
    }
    
    // æ›´æ–°ç‚¹å‡»è®°å½•
    this.lastClickTime = currentTime;
    this.lastClickIndex = targetIndex;
    
    // åˆ‡æ¢åˆ°ç›®æ ‡Tab
    this.currentIndex = targetIndex;
  }
  
  // æ›´æ–°WebViewä¸»é¢˜ï¼ˆé€šè¿‡ JavaScript æ£€æµ‹ç³»ç»Ÿä¸»é¢˜ï¼‰
  private updateWebViewTheme(): void {
    try {
      // é€šè¿‡ JavaScript çš„ matchMedia API æ£€æµ‹ç³»ç»Ÿä¸»é¢˜
      this.webViewController.runJavaScript(`
        (function() {
          const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          const theme = isDark ? 'dark' : 'light';
          if (document.documentElement) {
            document.documentElement.setAttribute('data-theme', theme);
            console.log('[Webåˆ†æé¡µ] ä¸»é¢˜å·²è®¾ç½®ä¸º: ' + theme);
          }
        })();
      `);
    } catch (e) {
      console.info('[ä¸»é¢˜] WebViewå°šæœªåŠ è½½ï¼Œç­‰å¾…onPageEndåè®¾ç½®');
    }
  }
  
  // æ„å»ºWebç‰ˆåˆ†æé¡µ
  @Builder
  buildWebAnalysisPage() {
    Column() {
      // é¡¶éƒ¨æç¤ºæ 
      Row() {
        Button({ type: ButtonType.Normal }) {
          Row({ space: 4 }) {
            Image($r('sys.symbol.chevron_left'))
              .fillColor('#2563eb')
              .width(18)
              .height(18)
            Text('è¿”å›åŸç”Ÿç‰ˆ')
              .fontSize(14)
              .fontColor('#2563eb')
          }
        }
        .backgroundColor('transparent')
        .onClick(() => {
          this.showWebAnalysis = false;
        })

        Blank()
        
        Text('ğŸŒ Webç‰ˆæ•°æ®åˆ†æ')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ right: 16 })
      }
      .width('100%')
      .height(44)
      .padding({ left: 12, right: 12 })
      .backgroundColor($r("app.color.home_background"))
      .borderWidth({ bottom: 1 })
      .borderColor($r("app.color.home_background"))

      // WebView
      Web({ src: 'https://znhj.iepose.cn/analysis.html', controller: this.webViewController })
        .layoutWeight(1)
        .width('100%')
        .javaScriptAccess(true)
        .domStorageAccess(true)
        .mixedMode(MixedMode.All)
        .cacheMode(CacheMode.Default)
        .darkMode(WebDarkMode.Auto) // è‡ªåŠ¨è·Ÿéšç³»ç»Ÿä¸»é¢˜
        .onPageBegin(() => {
          console.info('[Webåˆ†æé¡µ] å¼€å§‹åŠ è½½');
        })
        .onPageEnd(() => {
          console.info('[Webåˆ†æé¡µ] åŠ è½½å®Œæˆ');
          // é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®ä¸»é¢˜
          this.updateWebViewTheme();
        })
        .onErrorReceive((event) => {
          console.error('[Webåˆ†æé¡µ] åŠ è½½é”™è¯¯:', JSON.stringify(event));
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  // è‡ªå®šä¹‰ TabBar æ„å»ºå™¨
  @Builder
  TabBuilder(title: string, targetIndex: number, iconResource: Resource) {
    Column() {
      Image(iconResource)
        .size({ width: 24, height: 24 })
        .objectFit(ImageFit.Contain)
        // ã€å…³é”®ç‚¹ã€‘è¿™é‡Œä½¿ç”¨ fillColor åŠ¨æ€æ”¹å˜ SVG çš„é¢œè‰²
        .fillColor(this.currentIndex === targetIndex ? this.selectedColor : this.normalColor)
        // æ·»åŠ ä¸€ä¸ªç®€å•çš„ç¼©æ”¾åŠ¨ç”»æ•ˆæœï¼ˆå¯é€‰ï¼‰
        .scale({
          x: this.currentIndex === targetIndex ? 1.1 : 1.0,
          y: this.currentIndex === targetIndex ? 1.1 : 1.0
        })
        .animation({ duration: 200 })

      Text(title)
        .fontSize(10)
        .fontWeight(this.currentIndex === targetIndex ? FontWeight.Medium : FontWeight.Normal)
        .fontColor(this.currentIndex === targetIndex ? this.selectedColor : this.normalColor)
        .margin({ top: 4 })
    }
    .width('100%')
    .height('100%') // å¡«æ»¡ TabBar çš„é«˜åº¦
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      // å¤„ç†Tabç‚¹å‡»
      this.handleTabClick(targetIndex);
    })
  }
}