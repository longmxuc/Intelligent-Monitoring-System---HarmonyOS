import { SensorData, SERVER_HOST } from './DeviceDetailPageLogic';
import { DeviceInfo } from './DevicesPageLogic';
import { AnalysisDataLoadComponent } from './AnalysisDataLoadComponent';
import http from '@ohos.net.http';
import promptAction from '@ohos.promptAction';
import { webview } from '@kit.ArkWeb';
import { util } from '@kit.ArkTS';

@ComponentV2
export struct AnalysisPage {
  @Consumer('pageStack') pageStack: NavPathStack = new NavPathStack();
  @Local currentData: SensorData[] = [];
  @Local selectedDeviceId: string | null = null; // nullè¡¨ç¤ºå…¨éƒ¨è®¾å¤‡
  @Local deviceList: DeviceInfo[] = [];
  @Local isLoadingDevices: boolean = false;
  @Local hasData: boolean = false;
  @Local shouldBounce: boolean = false; // æ§åˆ¶å¼¹è·³åŠ¨ç”»
  
  // WebView æ§åˆ¶å™¨
  private webviewController: webview.WebviewController = new webview.WebviewController();

  aboutToAppear(): void {
    this.loadDeviceList();
  }
  
  // æ›´æ–° WebView ä¸­çš„æ•°æ®
  private updateWebViewData(): void {
    try {
      const message = JSON.stringify({
        type: 'updateData',
        sensorData: this.currentData,
        selectedDeviceId: this.selectedDeviceId,
        deviceList: this.deviceList
      });
      this.webviewController.runJavaScript(`
        window.postMessage(${message}, '*');
      `);
      console.info('å·²æ›´æ–° WebView æ•°æ®');
    } catch (err) {
      console.error('æ›´æ–° WebView æ•°æ®å¤±è´¥:', JSON.stringify(err));
    }
  }
  
  // æ›´æ–° WebView ä¸»é¢˜ï¼ˆé€šè¿‡ JavaScript æ£€æµ‹ç³»ç»Ÿä¸»é¢˜ï¼‰
  private updateWebViewTheme(): void {
    try {
      // é€šè¿‡ JavaScript çš„ matchMedia API æ£€æµ‹ç³»ç»Ÿä¸»é¢˜
      this.webviewController.runJavaScript(`
        (function() {
          const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          const theme = isDark ? 'dark' : 'light';
          if (document.documentElement) {
            document.documentElement.setAttribute('data-theme', theme);
            console.log('[AIåŠ©æ‰‹] ä¸»é¢˜å·²è®¾ç½®ä¸º: ' + theme);
          }
        })();
      `);
    } catch (err) {
      console.error('[AIåŠ©æ‰‹ä¸»é¢˜] è®¾ç½®å¤±è´¥:', JSON.stringify(err));
    }
  }
  
  // ä»£ç† AI è¯·æ±‚ï¼ˆé¿å… CORSï¼‰
  private async proxyAIRequest(requestBody: string): Promise<void> {
    try {
      console.info('é¸¿è’™ç«¯ä»£ç† AI è¯·æ±‚');
      
      const httpRequest: http.HttpRequest = http.createHttp();
      const url = `https://${SERVER_HOST}/api/ai/chat`;
      
      // ç›‘å¬å“åº”æ•°æ®ï¼ˆæµå¼å“åº”ï¼‰
      let fullResponse = '';
      let isFirstChunk = true;
      let lineBuffer = '';
      
      httpRequest.on('dataReceive', (data: ArrayBuffer) => {
        const decoder = new util.TextDecoder('utf-8', { fatal: false, ignoreBOM: true });
        const chunk = decoder.decodeWithStream(new Uint8Array(data), { stream: true });
        
        console.info('[AI] æ”¶åˆ°æ•°æ®å—ï¼Œé•¿åº¦:', chunk.length);
        
        // æ·»åŠ åˆ°è¡Œç¼“å†²åŒº
        lineBuffer += chunk;
        
        // å¤„ç†SSEæ ¼å¼ï¼šæŒ‰è¡Œåˆ†å‰²
        const lines = lineBuffer.split('\n');
        // ä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œ
        lineBuffer = lines.pop() || '';
        
        for (const line of lines) {
          const trimmedLine = line.trim();
          
          if (trimmedLine.startsWith('data: ')) {
            const dataStr = trimmedLine.substring(6).trim();
            
            if (dataStr === '[DONE]') {
              // æµå¼ä¼ è¾“å®Œæˆ
              console.info('[AI] æµå¼ä¼ è¾“å®Œæˆ');
              this.webviewController.runJavaScript(`
                window.handleAIStreamEnd();
              `);
              continue;
            }
            
            if (!dataStr) {
              continue;
            }
            
            try {
              const json = JSON.parse(dataStr) as Record<string, ESObject>;
              const choices = json['choices'] as Array<Record<string, ESObject>>;
              
              if (!choices || choices.length === 0) {
                continue;
              }
              
              const firstChoice = choices[0];
              const delta = firstChoice?.['delta'] as Record<string, ESObject>;
              const message = firstChoice?.['message'] as Record<string, ESObject>;
              const content = (delta?.['content'] || message?.['content'] || '') as string;
              const reasoningContent = (delta?.['reasoning_content'] || message?.['reasoning_content'] || '') as string;
              
              // å‘é€åˆ° WebView
              if (isFirstChunk && (content || reasoningContent)) {
                isFirstChunk = false;
                console.info('[AI] å¼€å§‹æµå¼ä¼ è¾“');
                this.webviewController.runJavaScript(`
                  window.handleAIStreamStart();
                `);
              }
              
              // å¤„ç†æ€è€ƒè¿‡ç¨‹
              if (reasoningContent) {
                fullResponse += reasoningContent;
                
                const escapedThinking = reasoningContent
                  .replace(/\\/g, '\\\\')
                  .replace(/'/g, "\\'")
                  .replace(/\n/g, '\\n')
                  .replace(/\r/g, '\\r')
                  .replace(/\t/g, '\\t');
                
                this.webviewController.runJavaScript(`
                  window.handleAIStreamChunk('${escapedThinking}', true);
                `);
              }
              
              // å¤„ç†æ­£å¸¸å†…å®¹
              if (content) {
                fullResponse += content;
                
                const escapedContent = content
                  .replace(/\\/g, '\\\\')
                  .replace(/'/g, "\\'")
                  .replace(/\n/g, '\\n')
                  .replace(/\r/g, '\\r')
                  .replace(/\t/g, '\\t');
                
                this.webviewController.runJavaScript(`
                  window.handleAIStreamChunk('${escapedContent}', false);
                `);
              }
            } catch (e) {
              console.error('[AI] è§£æJSONå¤±è´¥:', JSON.stringify(e), 'æ•°æ®:', dataStr.substring(0, 100));
            }
          }
        }
      });
      
      const response: http.HttpResponse = await httpRequest.request(url, {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json'
        },
        extraData: requestBody,
        connectTimeout: 60000,
        readTimeout: 120000,
        expectDataType: http.HttpDataType.STRING
      });
      
      console.info('AI å“åº”çŠ¶æ€:', response?.responseCode);
      
      if (response && response.responseCode === 200) {
        console.info('[AI] è¯·æ±‚æˆåŠŸå®Œæˆ');
        
        // å¦‚æœæ²¡æœ‰é€šè¿‡æµå¼æ¥æ”¶åˆ°æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´å“åº”
        if (!fullResponse && response.result) {
          const result = response.result as string;
          console.info('[AI] æ”¶åˆ°å®Œæ•´å“åº”ï¼Œé•¿åº¦:', result.length);
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯æµå¼æ ¼å¼ï¼ˆSSEï¼‰
          if (result.includes('data: ')) {
            console.info('[AI] æ£€æµ‹åˆ°SSEæ ¼å¼ï¼Œä½†æœªé€šè¿‡dataReceiveå¤„ç†ï¼Œå°è¯•æ‰‹åŠ¨è§£æ');
            // æ‰‹åŠ¨å¤„ç†SSEæ ¼å¼
            const lines = result.split('\n');
            let combinedContent = '';
            
            for (const line of lines) {
              if (line.trim().startsWith('data: ')) {
                const dataStr = line.trim().substring(6).trim();
                if (dataStr && dataStr !== '[DONE]') {
                  try {
                    const json = JSON.parse(dataStr) as Record<string, ESObject>;
                    const choices = json['choices'] as Array<Record<string, ESObject>>;
                    const delta = choices?.[0]?.['delta'] as Record<string, ESObject>;
                    const message = choices?.[0]?.['message'] as Record<string, ESObject>;
                    const content = (delta?.['content'] || message?.['content'] || '') as string;
                    if (content) {
                      combinedContent += content;
                    }
                  } catch (e) {
                    // å¿½ç•¥è§£æé”™è¯¯
                  }
                }
              }
            }
            
            if (combinedContent) {
              const escapedContent = combinedContent
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
              
              this.webviewController.runJavaScript(`
                window.handleAIResponse('${escapedContent}');
              `);
            }
          } else {
            // å°è¯•ä½œä¸ºæ™®é€šJSONè§£æ
            try {
              const json = JSON.parse(result) as Record<string, ESObject>;
              const choices = json['choices'] as Array<Record<string, ESObject>>;
              const message = choices?.[0]?.['message'] as Record<string, ESObject>;
              const content = (message?.['content'] || '') as string;
              
              if (content) {
                const escapedContent = content
                  .replace(/\\/g, '\\\\')
                  .replace(/'/g, "\\'")
                  .replace(/\n/g, '\\n')
                  .replace(/\r/g, '\\r')
                  .replace(/\t/g, '\\t');
                
                this.webviewController.runJavaScript(`
                  window.handleAIResponse('${escapedContent}');
                `);
              } else {
                console.error('[AI] æœªæ‰¾åˆ°æœ‰æ•ˆå†…å®¹');
                this.webviewController.runJavaScript(`
                  window.handleAIError('AIè¿”å›çš„å†…å®¹ä¸ºç©º');
                `);
              }
            } catch (e) {
              console.error('[AI] è§£æå“åº”å¤±è´¥:', JSON.stringify(e));
              console.error('[AI] å“åº”å‰100å­—ç¬¦:', result.substring(0, 100));
              this.webviewController.runJavaScript(`
                window.handleAIError('è§£æå“åº”å¤±è´¥ï¼Œè¯·é‡è¯•');
              `);
            }
          }
        } else if (fullResponse) {
          console.info('[AI] å·²é€šè¿‡æµå¼æ¥æ”¶å®Œæˆï¼Œæ€»é•¿åº¦:', fullResponse.length);
        }
      } else {
        const errorMsg = `è¯·æ±‚å¤±è´¥: ${response?.responseCode}`;
        this.webviewController.runJavaScript(`
          window.handleAIError('${errorMsg}');
        `);
      }
      
      httpRequest.destroy();
    } catch (err) {
      console.error('ä»£ç† AI è¯·æ±‚å¤±è´¥:', JSON.stringify(err));
      let errorMsg = 'è¯·æ±‚å¤±è´¥';
      if (err instanceof Error) {
        errorMsg = err.message;
      } else if (typeof err === 'string') {
        errorMsg = err;
      }
      this.webviewController.runJavaScript(`
        window.handleAIError('${errorMsg}');
      `);
    }
  }

  // åŠ è½½è®¾å¤‡åˆ—è¡¨
  private async loadDeviceList(): Promise<void> {
    this.isLoadingDevices = true;
    try {
      const httpRequest: http.HttpRequest = http.createHttp();
      const url = `http://${SERVER_HOST}/api/devices`;

      const response: http.HttpResponse = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json'
        }
      });

      httpRequest.destroy();

      if (response && response.responseCode === 200) {
        const result = JSON.parse(response.result as string) as Record<string, Object>;

        if (result['success'] === true && result['devices']) {
          const devices = result['devices'] as Array<Record<string, Object>>;
          this.deviceList = devices.map((item: Record<string, Object>) => {
            const id = item['id'] || item['device_id'] || '';
            return {
              id: String(id).trim().toUpperCase(),
              name: item['name'] as string | undefined,
              device_id: String(id).trim().toUpperCase(),
              description: item['description'] as string | undefined,
              has_ble: item['has_ble'] as boolean | undefined,
              has_mqtt: item['has_mqtt'] as boolean | undefined,
              via: item['via'] as string[] | undefined,
              online: item['online'] as boolean | undefined
            } as DeviceInfo;
          });
          console.info(`æˆåŠŸåŠ è½½ ${this.deviceList.length} ä¸ªè®¾å¤‡`);
        }
      }
    } catch (err) {
      console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', JSON.stringify(err));
      try {
        promptAction.showToast({ message: 'åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥', duration: 2000 });
      } catch (e) {
        console.error('æ˜¾ç¤ºToastå¤±è´¥:', JSON.stringify(e));
      }
    } finally {
      this.isLoadingDevices = false;
    }
  }

  // å¤„ç†æ•°æ®åŠ è½½å®Œæˆ
  private onDataLoaded(data: SensorData[], count: number): void {
    this.currentData = data;
    this.hasData = data.length > 0;
    console.info(`åˆ†æé¡µï¼šæˆåŠŸåŠ è½½ ${count} æ¡æ•°æ®`);
    
    // æ›´æ–° WebView ä¸­çš„æ•°æ®
    if (this.hasData) {
      setTimeout(() => {
        this.updateWebViewData();
      }, 500);
    }
  }

  // å¤„ç†è®¾å¤‡é€‰æ‹©å˜åŒ–
  private onDeviceChanged(deviceId: string | null): void {
    this.selectedDeviceId = deviceId;
    // åˆ‡æ¢è®¾å¤‡æ—¶æ¸…ç©ºå½“å‰æ•°æ®
    this.currentData = [];
    this.hasData = false;
    
    // æ›´æ–° WebView
    this.updateWebViewData();
  }

  build() {
    Column() {
      Scroll() {
        Column({ space: 16 }) {
          // æ•°æ®åŠ è½½åŒºåŸŸ
          Column({ space: 12 }) {
            Text('ğŸ” æ•°æ®åŠ è½½')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r("app.color.home_value_text"))
              .width('100%')

            Text('é€‰æ‹©æ•°æ®åŠ è½½æ–¹å¼ï¼Œæ”¯æŒæŒ‰æ¡æ•°ã€æŒ‰æ—¶é—´èŒƒå›´ã€è‡ªå®šä¹‰æ—¶é—´æˆ–åŠ è½½å…¨éƒ¨æ•°æ®ã€‚')
              .fontSize(13)
              .fontColor($r("app.color.home_status_text"))
              .width('100%')
              .margin({ bottom: 8 })

            // æ•°æ®åŠ è½½ç»„ä»¶ï¼ˆæ”¯æŒè®¾å¤‡é€‰æ‹©ï¼‰
            AnalysisDataLoadComponent({
              deviceList: this.deviceList,
              selectedDeviceId: this.selectedDeviceId,
              shouldBounce: this.shouldBounce,
              onDeviceChanged: (deviceId: string | null) => {
                this.onDeviceChanged(deviceId);
              },
              onDataLoaded: (data: SensorData[], count: number) => {
                this.onDataLoaded(data, count);
              }
            })
          }
          .width('100%')
          .padding(16)
          .backgroundColor($r("app.color.home_card_background"))
          .borderRadius(12)
          .border({
            width: 1,
            color: $r("app.color.home_card_border"),
            style: BorderStyle.Solid
          })
          .shadow({
            radius: 8,
            color: '#1F000000',
            offsetX: 0,
            offsetY: 2
          })
          .margin({ left: 16, right: 16, top: 8 })

          // AI åˆ†æåŠ©æ‰‹ï¼ˆä½¿ç”¨ WebViewï¼‰
          Web({ src: $rawfile('ai_chat.html'), controller: this.webviewController })
            .width('100%')
            .height(600)
            .borderRadius(12)
            .margin({ left: 16, right: 16 })
            .backgroundColor($r("app.color.home_background"))
            .clip(true) // è£å‰ªè¾¹ç•Œï¼Œç¡®ä¿åœ†è§’ç”Ÿæ•ˆ
            .darkMode(WebDarkMode.Auto) // è‡ªåŠ¨è·Ÿéšç³»ç»Ÿä¸»é¢˜
            .onControllerAttached(() => {
              console.info('WebView æ§åˆ¶å™¨å·²é™„åŠ ');
              // WebView åŠ è½½å®Œæˆåï¼Œç«‹å³æ›´æ–°æ•°æ®å’Œä¸»é¢˜
              setTimeout(() => {
                this.updateWebViewData();
                this.updateWebViewTheme();
              }, 1000);
            })
            .javaScriptAccess(true)
            .domStorageAccess(true)
            .fileAccess(true)
            .mixedMode(MixedMode.All)
            .cacheMode(CacheMode.None)
            .onlineImageAccess(true)
            .imageAccess(true)
            .blockNetwork(false)
            .onSslErrorEventReceive((event) => {
              // å…è®¸ HTTP è¯·æ±‚ï¼ˆå¿½ç•¥ SSL é”™è¯¯ï¼‰
              console.warn('WebView SSL é”™è¯¯ï¼Œç»§ç»­åŠ è½½');
              event.handler.handleConfirm();
            })
            .onErrorReceive((event) => {
              console.error('WebView é”™è¯¯:', JSON.stringify(event));
              if (event?.error) {
                console.error('é”™è¯¯è¯¦æƒ…:', event.error.getErrorInfo());
              }
            })
            .onPageEnd(() => {
              console.info('WebView é¡µé¢åŠ è½½å®Œæˆ');
              // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ›´æ–°æ•°æ®å’Œä¸»é¢˜
              setTimeout(() => {
                this.updateWebViewData();
                this.updateWebViewTheme();
              }, 500);
            })
            .onConsole((event) => {
              // è½¬å‘ WebView çš„ console æ—¥å¿—
              const msg = event?.message.getMessage();
              console.info('[WebView Console]', msg);
              
              // æ‹¦æˆª AI è¯·æ±‚è°ƒç”¨
              if (msg && msg.includes('[AI_REQUEST]')) {
                try {
                  const jsonStr = msg.substring(msg.indexOf('{'));
                  this.proxyAIRequest(jsonStr);
                } catch (e) {
                  console.error('è§£æ AI è¯·æ±‚å¤±è´¥:', e);
                }
              }
              
              // æ‹¦æˆªéœ€è¦åŠ è½½æ•°æ®çš„æç¤º
              if (msg && msg.includes('[NEED_LOAD_DATA]')) {
                try {
                  promptAction.showToast({ 
                    message: 'âš ï¸ è¯·å…ˆåŠ è½½ä¼ æ„Ÿå™¨æ•°æ®', 
                    duration: 2500,
                    bottom: 200
                  });
                  
                  // è§¦å‘å¼¹è·³åŠ¨ç”»
                  this.shouldBounce = true;
                  setTimeout(() => {
                    this.shouldBounce = false;
                  }, 1000);
                } catch (e) {
                  console.error('æ˜¾ç¤ºToastå¤±è´¥:', e);
                }
              }
              
              return false;
            })
            .onHttpErrorReceive((event) => {
              console.error('[WebView HTTPé”™è¯¯]', JSON.stringify({
                url: event?.request.getRequestUrl(),
                statusCode: event?.response.getResponseCode()
              }));
            })

          // åº•éƒ¨ç©ºç™½ï¼Œé¿å…è¢«æµ®åŠ¨æŒ‰é’®é®æŒ¡
          Blank()
            .height(100)
        }
      }
      .layoutWeight(1)
      .width('100%')
    }
    .padding({left:10,right:10})
    .width('100%')
    .height('100%')
    .backgroundColor($r("app.color.home_background"))
  }
}

