import { HomePageLogic, TrendResult, SERVER_HOST } from './HomePageLogic';
import webview from '@ohos.web.webview';
import http from '@ohos.net.http';

// å®šä½æŸ¥è¯¢æ¥å£è¿”å›ç»“æ„
interface LocationQueryResponse {
  success?: boolean;
  message?: string;
  error?: string;
}

// é¡¶å±‚è¶‹åŠ¿è¡Œç»„ä»¶ï¼ˆé¿å…ä½œç”¨åŸŸé—®é¢˜ï¼‰
@Component
struct TrendRow {
  @Prop trend: TrendResult;

  build() {
    Row({ space: 4 }) {
      if (this.trend.direction === 'up') {
        Text('â†‘')
          .fontSize(14)
          .fontColor('#dc2626')
      } else if (this.trend.direction === 'down') {
        Text('â†“')
          .fontSize(14)
          .fontColor('#16a34a')
      } else {
        Text('â€”')
          .fontSize(14)
          .fontColor('#64748b')
      }
      Text(this.trend.text)
        .fontSize(12)
        .fontColor(this.trend.direction === 'up' ? '#dc2626' :
          this.trend.direction === 'down' ? '#16a34a' : '#64748b')
    }

  }
}

// é¡¶å±‚æŒ‡æ ‡å¡ç‰‡ç»„ä»¶
@Component
struct MetricCard {
  @Prop title: string;
  @Prop valueText: string;
  @Prop trend: TrendResult;
  @Prop valueFontSize: number;

  build() {
    Row({ space: 5 }) {
      Column() {
        Column({ space: 10 }) {
          Text(this.title)
            .fontSize(14)
            .fontColor($r("app.color.home_title_text"))
          Text(this.valueText)
            .fontSize(this.valueFontSize)
            .fontWeight(FontWeight.Bolder)
            .fontColor($r("app.color.home_value_text"))
            .maxLines(1)
        }
        .alignItems(HorizontalAlign.Start)

        TrendRow({ trend: this.trend })
      }
      .height('100%')
      .alignItems(HorizontalAlign.Start)
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width("100%")
    .height(100)
    .padding({
      left: 10,
      top: 10,
      right: 10,
      bottom: 10
    })
    .borderColor($r("app.color.home_card_border"))
    .borderWidth(1)
    .backgroundColor($r("app.color.home_card_background"))
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#1F000000',
      offsetX: 0,
      offsetY: 2
    })
  }
}


@Component
export struct HomePage {
  // UI çŠ¶æ€
  @State wsConnected: boolean = false;
  @State temp: number | undefined = undefined;
  @State hum: number | undefined = undefined;
  @State lux: number | undefined = undefined;
  @State smoke: number | undefined = undefined;
  @State pressure: number | undefined = undefined;
  @State temp2: number | undefined = undefined;
  @State rs_ro: number | undefined = undefined;
  @State lastUpdateTime: string = '--:--:--';
  @State sampleCount: number = 0;
  // è¶‹åŠ¿çŠ¶æ€
  @State tempTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @State humTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @State luxTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @State smokeTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @State pressureTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  @State tempDiffTrend: TrendResult = { direction: 'stable', value: 0, text: 'è¶‹åŠ¿ç¨³å®š' };
  // å®šä½çŠ¶æ€
  @State locationStatus: string = 'æœªè·å–å®šä½';
  @State locationStatusColor: string = '#9ca3af';
  @State locationLon: string = '--';
  @State locationLat: string = '--';
  @State locationExtra: string = '';
  @State locationAvailable: boolean = false;
  @State showLocationMap: boolean = false;
  @State isQueryingLocation: boolean = false;
  // ä¸šåŠ¡é€»è¾‘å®ä¾‹ï¼ˆè´Ÿè´£ WebSocket ä¸æ•°æ®å¤„ç†ï¼‰
  private logic: HomePageLogic | null = null;
  // H5 åœ°å›¾ Web æ§åˆ¶å™¨
  private mapWebController: webview.WebviewController = new webview.WebviewController();

  // ç”Ÿæˆ H5 åœ°å›¾é¡µé¢çš„åœ°å€ï¼ˆé€šè¿‡ query ä¼ å…¥ç»çº¬åº¦ï¼‰
  private getLocationMapUrl(): string {
    const baseUrl: string = 'resource://RAWFILE/location_map.html';
    if (!this.locationAvailable) {
      return baseUrl;
    }
    const lonNum: number = Number.parseFloat(this.locationLon);
    const latNum: number = Number.parseFloat(this.locationLat);
    if (Number.isNaN(lonNum) || Number.isNaN(latNum)) {
      return baseUrl;
    }
    // åªä¼ ç»çº¬åº¦ï¼Œå…¶ä»–ä¿¡æ¯åœ¨å¡ç‰‡ä¸­å±•ç¤º
    return `${baseUrl}?lon=${lonNum}&lat=${latNum}`;
  }

  // å‘é€å®šä½æŸ¥è¯¢å‘½ä»¤ï¼ˆHTTP è°ƒç”¨åç«¯ /api/location/queryï¼‰
  private async sendLocationQuery(): Promise<void> {
    if (this.isQueryingLocation) {
      return;
    }

    this.isQueryingLocation = true;
    this.locationStatus = 'æ­£åœ¨è·å–å®šä½...';
    this.locationStatusColor = '#f59e0b';

    const httpRequest: http.HttpRequest = http.createHttp();

    try {
      const url: string = `http://${SERVER_HOST}/api/location/query`;
      const response: http.HttpResponse = await httpRequest.request(url, {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': 'application/json'
        }
      });

      let isOk: boolean = false;
      if (response && response.responseCode === 200) {
        // å¦‚æœåç«¯è¿”å› JSONï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŒ‰éœ€è§£æ
        // è¿™é‡Œä¸ºäº†é¿å… any/unknownï¼Œä»…æ ¹æ®çŠ¶æ€ç åˆ¤æ–­æˆåŠŸ
        isOk = true;
      }

      if (!isOk) {
        this.locationStatus = 'è·å–å¤±è´¥';
        this.locationStatusColor = '#ef4444';
      }
      // æˆåŠŸçš„æƒ…å†µï¼šä¿æŒâ€œæ­£åœ¨è·å–å®šä½...â€ï¼Œç­‰å¾… WebSocket æ¨é€ location æ•°æ®æ¥æ›´æ–° UI
    } catch {
      console.error('å®šä½æŸ¥è¯¢è¯·æ±‚å¤±è´¥');
      this.locationStatus = 'è¯·æ±‚å¤±è´¥';
      this.locationStatusColor = '#ef4444';
    } finally {
      httpRequest.destroy();
      this.isQueryingLocation = false;
    }
  }

  // ç”Ÿå‘½å‘¨æœŸå‡½æ•°
  aboutToAppear() {
    if (this.logic === null) {
      this.logic = new HomePageLogic(this);
    }
    this.logic.aboutToAppear();
  }

  aboutToDisappear() {
    if (this.logic) {
      this.logic.aboutToDisappear();
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Image($r("app.media.logo"))
          .width(150)
        Text("æ™ºèƒ½ç¯å¢ƒç›‘æµ‹ç³»ç»Ÿ")
          .fontWeight(FontWeight.Bolder)
          .fontSize(20)
      }
      .justifyContent(FlexAlign.Center)
      .width("100%")
      .margin({ bottom: 10, right: 20 })

      // çŠ¶æ€æ 
      Row({ space: 10 }) {
        // è¿æ¥çŠ¶æ€
        Row({ space: 5 }) {
          Row()
            .backgroundColor(this.wsConnected ? "#4CA154" : "#E53E3E")
            .width(12)
            .height(12)
            .borderRadius(100)
          Text(this.wsConnected ? "å·²è¿æ¥" : "æœªè¿æ¥")
            .fontColor($r("app.color.home_status_text"))
            .fontSize(12)
        }
        .padding({
          left: 10,
          right: 10,
          top: 5,
          bottom: 5
        })
        .borderColor($r("app.color.home_border"))
        .borderWidth(1)
        .borderRadius(30)

        // ä¸Šæ¬¡æ›´æ–°
        Row({ space: 5 }) {
          Text(`ä¸Šæ¬¡æ›´æ–°: ${this.lastUpdateTime}`)
            .fontColor($r("app.color.home_status_text"))
            .fontSize(12)
        }
        .padding({
          left: 10,
          right: 10,
          top: 5,
          bottom: 5
        })
        .borderColor($r("app.color.home_border"))
        .borderWidth(1)
        .borderRadius(30)

        // æ ·æœ¬æ•°
        Row({ space: 5 }) {
          Text(`æ ·æœ¬æ•°: ${this.sampleCount}`)
            .fontColor($r("app.color.home_status_text"))
            .fontSize(12)
        }
        .padding({
          left: 10,
          right: 10,
          top: 5,
          bottom: 5
        })
        .borderColor($r("app.color.home_border"))
        .borderWidth(1)
        .borderRadius(30)
      }
      .width("100%")
      .justifyContent(FlexAlign.Center)
      // .backgroundColor(Color.Red)
      .padding({ left: 10, right: 10 })

      Scroll() {
        Column({ space: 15 }) {
          // ä¼ æ„Ÿå™¨æ•°æ®å±•ç¤ºåŒºåŸŸï¼ˆGrid ä¸‰åˆ—ä¸¤è¡Œï¼‰
          Grid() {
            // æ¸©åº¦
            GridItem() {
              MetricCard({
                title: "æ¸©åº¦",
                valueText: `${this.temp !== undefined && this.temp !== null ? this.temp.toFixed(2) : '--'} â„ƒ`,
                trend: this.tempTrend,
                valueFontSize: 24
              })
            }

            // æ¸©å·® Î”
            GridItem() {
              MetricCard({
                title: "æ¸©åº¦ Î”",
                valueText: `${this.temp !== undefined && this.temp !== null && this.temp2 !== undefined &&
                  this.temp2 !== null ? Math.abs(this.temp - this.temp2).toFixed(2) : '--'} â„ƒ`,
                trend: this.tempDiffTrend,
                valueFontSize: 24
              })
            }

            // æ¹¿åº¦
            GridItem() {
              MetricCard({
                title: "æ¹¿åº¦",
                valueText: `${this.hum !== undefined && this.hum !== null ? this.hum.toFixed(2) : '--'} %`,
                trend: this.humTrend,
                valueFontSize: 24
              })
            }

            // äº®åº¦
            GridItem() {
              MetricCard({
                title: "äº®åº¦",
                valueText: `${this.lux !== undefined && this.lux !== null ? this.lux.toFixed(1) : '--'} lux`,
                trend: this.luxTrend,
                valueFontSize: 24
              })
            }

            // çƒŸé›¾
            GridItem() {
              MetricCard({
                title: "çƒŸé›¾",
                valueText: `${this.smoke !== undefined && this.smoke !== null ? this.smoke.toFixed(1) : '--'} ppm`,
                trend: this.smokeTrend,
                valueFontSize: 24
              })
            }

            // å¤§æ°”å‹
            GridItem() {
              MetricCard({
                title: "å¤§æ°”å‹",
                valueText: `${this.pressure !== undefined && this.pressure !== null ? this.pressure.toFixed(1) :
                  '--'} hPa`,
                trend: this.pressureTrend,
                valueFontSize: 22
              })
            }
          }
          .columnsTemplate("1fr 1fr")
          // .rowsTemplate("auto auto auto")
          .columnsGap(12)
          .rowsGap(12)
          .constraintSize({ maxWidth: 600 })
          .width("100%")
          .padding({
            // left: 15,
            // right: 15,
            top: 15
          })

          // å®šä½ä¿¡æ¯å¡ç‰‡ï¼ˆå‚è€ƒ README/index.html çš„å¸ƒå±€ä¸é…è‰²ï¼‰
          Column() {
            Row({ space: 8 }) {
              Text("ğŸ“ è®¾å¤‡å®šä½")
                .fontWeight(FontWeight.Bolder)
                .fontSize(16)
                .fontColor($r("app.color.home_value_text"))
              Text(this.locationStatus)
                .fontColor(this.locationStatusColor)
                .fontSize(12)
                .margin({ left: 8 })
            }
            .width("100%")

            if (this.locationAvailable) {
              Grid() {
                GridItem() {
                  Column({ space: 4 }) {
                    Text("ç»åº¦")
                      .fontSize(12)
                      .fontColor($r("app.color.home_status_text"))
                    Text(this.locationLon)
                      .fontSize(22)
                      .fontWeight(FontWeight.Bolder)
                      .fontColor($r("app.color.home_value_text"))
                  }
                }

                GridItem() {
                  Column({ space: 4 }) {
                    Text("çº¬åº¦")
                      .fontSize(12)
                      .fontColor($r("app.color.home_status_text"))
                    Text(this.locationLat)
                      .fontSize(22)
                      .fontWeight(FontWeight.Bolder)
                      .fontColor($r("app.color.home_value_text"))
                  }
                }
              }
              .columnsTemplate("1fr 1fr")
              .columnsGap(12)
              .margin({ top: 10 })
            } else {
              Text("ç­‰å¾…æœåŠ¡å™¨æ¨é€å®šä½æ•°æ®...")
                .fontSize(12)
                .fontColor($r("app.color.home_status_text"))
                .margin({ top: 10 })
            }

            if (this.locationExtra && this.locationExtra.length > 0) {
              Text(this.locationExtra)
                .fontSize(12)
                .fontColor($r("app.color.home_status_text"))
                .margin({ top: 8 })
            }

            // å‘é€å®šä½æŒ‰é’® + åœ°å›¾å¼€å…³
            Row({ space: 8 }) {
              Button(this.isQueryingLocation ? "â³ æ­£åœ¨è·å–å®šä½..." : "ğŸ“ å‘é€å®šä½")
                .fontSize(12)
                .fontColor(Color.White)
                .backgroundColor('#2563eb')
                .borderRadius(8)
                .padding({
                  left: 10,
                  right: 10,
                  top: 6,
                  bottom: 6
                })
                .enabled(!this.isQueryingLocation)
                .onClick(() => {
                  if (this.isQueryingLocation) {
                    return;
                  }
                  this.sendLocationQuery();
                  // ä¸»åŠ¨å±•å¼€åœ°å›¾ï¼Œç­‰å¾…å®šä½ç»“æœ
                  if (!this.showLocationMap) {
                    this.showLocationMap = true;
                  }
                })

              Button(this.showLocationMap ? "ğŸ—º æ”¶èµ·åœ°å›¾" : "ğŸ—º æ˜¾ç¤ºåœ°å›¾")
                .fontSize(12)
                .fontColor(Color.White)
                .backgroundColor(this.locationAvailable ? '#2563eb' : '#4b5563')
                .borderRadius(8)
                .padding({
                  left: 10,
                  right: 10,
                  top: 6,
                  bottom: 6
                })
                .enabled(this.locationAvailable)
                .onClick(() => {
                  if (!this.locationAvailable) {
                    return;
                  }
                  this.showLocationMap = !this.showLocationMap;
                })
            }
            .margin({ top: 10 })

            if (this.locationAvailable) {
              // å§‹ç»ˆæ¸²æŸ“åœ°å›¾å®¹å™¨ï¼Œé€šè¿‡é«˜åº¦å’Œé€æ˜åº¦é…åˆ animation å®ç°è¿‡æ¸¡åŠ¨ç”»
              Column() {
                Web({
                  src: this.getLocationMapUrl(),
                  controller: this.mapWebController
                })
                  .javaScriptAccess(true)
                  .width('100%')
                  .height('100%')
              }
              .width('100%')
              .height(this.showLocationMap ? 260 : 0)
              .opacity(this.showLocationMap ? 1 : 0)
              .margin({ top: 12 })
              .animation({
                duration: 250,
                curve: Curve.EaseInOut
              })
            }
          }
          .constraintSize({ maxWidth: 600 })
          .width("100%")
          .padding({
            left: 12,
            right: 12,
            top: 12,
            bottom: 12
          })
          .borderColor($r("app.color.home_card_border"))
          .borderWidth(1)
          .backgroundColor($r("app.color.home_card_background"))
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: '#1F000000',
            offsetX: 0,
            offsetY: 2
          })
        }
      }
      .width("100%")
      .padding({bottom:100})

    }

    .backgroundColor($r("app.color.home_background"))
    .width("100%")
    .height("100%")
    .expandSafeArea()
  }
}
